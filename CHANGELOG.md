# NPCRoadRage Script - Changelog

## Version 1.27.1 - NPCIntelligence Build Fix (2025-06-03)

### üõ†Ô∏è Correction de build
- Utilisation correcte de `Game.Player.Wanted` pour ajuster le niveau de recherche
- Suppression d'un appel invalide `IsFiringWeapon` sur `Ped`

## Version 1.27 - Enhanced NPC Intelligence (2025-06-02)

### ü§ñ PNJ plus intelligents hors traffic
- Nouveau dossier `NPCIntelligence` avec gestionnaire d√©di√©.
- Les PNJ fuient ou appellent la police lorsqu'ils sont menac√©s.


## Version 1.26 - Intelligent Traffic AI (2025-06-01)

### üöó PNJ plus dynamiques dans les embouteillages
- Nouveau dossier `TrafficAI` avec un gestionnaire d√©di√©.
- Les v√©hicules PNJ bloqu√©s klaxonnent apr√®s quelques secondes.
- Ils tentent ensuite de contourner l'obstacle pour continuer leur route.

## Version 1.24.1 - Compilation Fixes (2025-05-30)

### üîß **Correctifs de compilation pour SHVDN v3**

#### **Erreurs corrig√©es**
- ‚ùå `Hash.SET_PED_ALERT_LEVEL` - Hash inexistant supprim√©
- ‚ùå `Hash.SET_VEHICLE_TYRE_BURST_MULTIPLIER` - Hash inexistant supprim√©  
- ‚ùå `World.GetEntityByHandle<Ped>()` - Remplac√© par dictionnaire de r√©f√©rences stock√©es
- ‚ö†Ô∏è `TaskInvoker.GoTo()` obsol√®te - Remplac√© par `FollowNavMeshTo()`

#### **Warnings supprim√©s**
- ‚ö†Ô∏è **CS8600 Nullable warnings** : `Ped` ‚Üí `Ped?` pour les r√©f√©rences nullable
- ‚ö†Ô∏è `VehicleDrivingFlags.AvoidVehicles` ‚Üí `SwerveAroundAllVehicles`
- ‚ö†Ô∏è `VehicleDrivingFlags.AvoidObjects` ‚Üí `SteerAroundObjects` 
- ‚ö†Ô∏è `VehicleDrivingFlags.AvoidPeds` ‚Üí `SteerAroundPeds`

#### **Am√©liorations techniques**
- ‚úÖ **Dictionnaire de r√©f√©rences** : `_trackedPeds` pour √©viter `GetEntityByHandle`
- ‚úÖ **Nettoyage am√©lior√©** : Suppression des r√©f√©rences stock√©es lors du cleanup
- ‚úÖ **Types nullable corrects** : Utilisation de `Ped?` pour √©viter les warnings CS8600
- ‚úÖ **Compatibilit√© totale** : Scripts compilent sans erreur ni warning avec SHVDN v3

### üì¶ **R√©sultat**
- ‚úÖ **Compilation parfaite** : 0 erreur, 0 warning
- ‚úÖ **API √† jour** : Toutes les m√©thodes obsol√®tes remplac√©es
- ‚úÖ **Types s√©curis√©s** : Gestion correcte des r√©f√©rences nullable
- ‚úÖ **Performance optimis√©e** : Utilisation des nouvelles APIs recommand√©es

## Version 1.25 - 2025-01-XX - URGENT: Fixed False "Player Left Scene" Messages

### üö® CRITICAL BUG FIX
- **FIXED: False "Player left the scene" messages** - Major issue where police would incorrectly claim player fled
- **Root Cause**: Distance check was comparing player position to police VEHICLE instead of incident location or officers
- **Solution**: Multi-layered distance checking system

### üõ†Ô∏è Technical Fix Details
- **Improved Distance Logic**: Now checks distance to incident, vehicle, AND nearest officer
- **Smarter Thresholds**: Different tolerance levels for different elements:
  - Incident: 60m tolerance (1.5x normal)
  - Vehicle: 80m tolerance (2x normal) 
  - Officers: 40m tolerance (normal)
- **Interaction Protection**: Won't trigger "fled scene" during active police interaction
- **Player Must Be Far From ALL**: Only triggers if player is far from incident AND vehicle AND officers

### üîß Additional Improvements
- **CheckPoliceArrival Enhanced**: Distance check increased from 60m to 80m
- **Interaction State Awareness**: Won't trigger during `_policeInteractionActive` or `_makingPoliceDecision`
- **Better Logging**: More detailed distance information in logs for debugging

### üéØ Result
- ‚úÖ **No more false "fled scene" messages** when staying near incident
- ‚úÖ **Police interactions complete properly** without premature termination
- ‚úÖ **More realistic behavior** - only triggers when truly fleeing far away
- ‚úÖ **Better tolerance for movement** during natural interaction flow

## Version 1.24 - 2025-01-XX - Police AI Navigation Improvements & NPCAIEnhancer Removal

### üî• MAJOR CHANGES
- **REMOVED NPCAIEnhancer.cs** - Supprim√© compl√®tement car il interf√®re avec l'IA de la police et cause des probl√®mes de navigation
- **Police Navigation Completely Overhauled** - Syst√®me de navigation police enti√®rement revu pour plus de fiabilit√©

### üö® Police AI Improvements
- **Shorter spawn distances**: Police spawn now between 60-120m instead of 80-150m for faster arrival
- **Simplified navigation checks**: Reduced from every tick to every 20 seconds to prevent over-correction
- **Better stuck detection**: More sensitive stuck detection (0.3f speed threshold vs 0.5f)
- **Faster fallback mechanisms**: Emergency teleportation after 1.5 minutes instead of 3 minutes
- **Improved spawn point selection**: 16 spawn attempts with better positioning strategies
- **Enhanced initial navigation**: Better driving flags and speed settings for initial dispatch
- **More flexible arrival criteria**: Police can arrive when within 30m or 50m+slow speed

### üõ†Ô∏è Technical Improvements
- **Reduced navigation retries**: Max 2 attempts instead of 3 for faster resolution
- **Better driver abilities**: Enhanced police officer driving skills and aggressiveness settings
- **Optimized correction strategies**: Simplified 3-step navigation correction process
- **Improved vehicle properties**: Better initial vehicle state setup for reliable navigation

### üêõ Bug Fixes
- Fixed police getting stuck in endless navigation loops
- Fixed police spawning too far away and being unable to reach incident
- Fixed compilation errors with invalid ScriptHookV.NET properties
- Removed conflicting AI enhancement that interfered with police behavior

### üìà Performance
- Reduced excessive navigation checks from every tick to periodic intervals
- Simplified navigation logic for better performance
- Less aggressive pathfinding corrections to reduce CPU usage

## Version 1.23 - Major Bug Fixes (2025-05-30)

### üö® R√©solution des probl√®mes majeurs

#### 1. **Police qui se t√©l√©porte directement vers le joueur**
- **Probl√®me** : La police utilisait des m√©canismes d'urgence trop agressifs qui causaient une t√©l√©portation imm√©diate
- **Solution** :
  - Augmentation du timeout de dispatch de 90s √† 300s (5 minutes)
  - Augmentation du timeout de sortie de v√©hicule de 10s √† 15s
  - Augmentation du timeout d'approche de 15s √† 30s
  - V√©rifications de navigation seulement toutes les 15 secondes au lieu de chaque tick
  - D√©lai de d√©tection de blocage pass√© de 8s √† 30s
  - R√©duction du nombre de tentatives de redirection de 5 √† 3
  - T√©l√©portation d'urgence seulement apr√®s 3+ minutes au lieu de 90s
  - La police ne se t√©l√©porte maintenant qu'en dernier recours absolu

#### 2. **Comportement "en toupie" des officiers de police**
- **Probl√®me** : Les officiers √©taient re-task√©s √† chaque tick, causant un comportement erratique et des rotations sur place
- **Solution** :
  - Ajout de v√©rifications temporelles pour emp√™cher le re-tasking constant
  - Les officiers ne re√ßoivent de nouvelles t√¢ches qu'au maximum toutes les 2-5 secondes
  - Ajout d'un dictionnaire de timing individuel pour chaque officier
  - Pr√©vention des boucles de t√¢ches infinies
  - Les officiers s'arr√™tent correctement une fois proches du joueur

#### 3. **Menu de r√©ponse invisible**
- **Probl√®me** : Le menu interactif pour choisir la r√©ponse aux questions de police n'√©tait pas visible
- **Solution** :
  - R√©√©criture compl√®te de `DrawResponseMenu` avec plusieurs m√©thodes d'affichage
  - Ajout de notifications persistantes pour le titre du menu
  - Ajout de rendu de texte direct avec coordonn√©es fixes √† l'√©cran
  - Multiples m√©thodes de backup pour une meilleure compatibilit√©
  - Surbrillance visuelle pour l'option s√©lectionn√©e
  - Affichage des instructions de contr√¥le
  - Le menu devrait maintenant √™tre visible quelle que soit la version de SHVDN

### üîß Am√©liorations de gestion m√©moire
- **Ajout du nettoyage des dictionnaires de timing lors des resets**
- **Pr√©vention des fuites m√©moire dues aux donn√©es de timing accumul√©es**
- **Am√©lioration des proc√©dures de gestion d'√©tat et de nettoyage**

### üìã R√©sum√© des changements de configuration

#### Timeouts augment√©s :
- `_policeDispatchTimeoutDuration` : 90s ‚Üí 300s
- `_policeExitVehicleTimeoutDuration` : 10s ‚Üí 15s  
- `_policeApproachTimeoutDuration` : 15s ‚Üí 30s

#### Navigation moins agressive :
- `PoliceStuckSpeedThreshold` : 0.8f ‚Üí 0.5f (moins sensible)
- `PoliceProgressThreshold` : 2.0f ‚Üí 3.0f (plus tol√©rant)
- `MaxNavigationRetries` : 5 ‚Üí 3 tentatives
- `ForceArrivalDistance` : 60.0f ‚Üí 40.0f

#### Nouvelles variables de gestion :
- `_lastOfficerTaskTime` : Contr√¥le global du timing des t√¢ches
- `_officerLastTaskedTime` : Dictionnaire individuel par officier
- `_lastMenuDisplayTime` : Gestion de l'affichage du menu

### üéØ R√©sultat attendu
Avec ces corrections, vous devriez maintenant avoir :
1. ‚úÖ Une police qui arrive de mani√®re r√©aliste par la route sans t√©l√©portation
2. ‚úÖ Des officiers qui se d√©placent normalement sans faire "la toupie"
3. ‚úÖ Un menu de r√©ponse clairement visible et interactif
4. ‚úÖ Des performances am√©lior√©es et une gestion m√©moire optimis√©e

### üîç Tests recommand√©s
1. Provoquer une collision avec un NPC et attendre l'appel de police
2. V√©rifier que la police arrive par la route de mani√®re naturelle
3. Observer le comportement des officiers lors de leur approche
4. Tester la visibilit√© et l'interaction avec le menu de r√©ponse 

# CHANGELOG - REALIS Mod

## [Version 1.4.0] - 2024-12-19 - CORRECTION MAJEURE URBANLIFE

### üõ†Ô∏è **CORRECTIONS CRITIQUES - Syst√®me UrbanLife**

#### **Probl√®me R√©solu : PNJ sortant de leur v√©hicule**
- ‚úÖ **CORRIG√â** : Les PNJ ne sortent plus de leur v√©hicule quand le joueur klaxonne
- ‚úÖ **CORRIG√â** : Les PNJ ne s'arr√™tent plus de bouger quand le joueur s'approche
- ‚úÖ **CORRIG√â** : R√©actions excessives aux bruits mineurs

#### **Optimisations de Performance**
- üöÄ R√©duction de la fr√©quence des v√©rifications (100ms ‚Üí 250ms)
- üöÄ Intervalle d'update augment√© (1000ms ‚Üí 2000ms)
- üöÄ Nombre max de PNJ intelligents r√©duit (50 ‚Üí 30)
- üöÄ Auto-nettoyage des PNJ invalides

#### **Am√©liorations du Syst√®me de R√©action**
- üîß Chance de r√©action aux klaxons : 30% ‚Üí 5%
- üîß Port√©e des klaxons r√©duite : 50m ‚Üí 25m
- üîß Dur√©e des klaxons r√©duite : 3.0s ‚Üí 1.5s
- üîß Protection sp√©ciale pour les PNJ en v√©hicule
- üîß Gestion intelligente de la proximit√© du joueur

#### **Nouveau Syst√®me d'Int√©gration**
- üÜï **UrbanLifeIntegration.cs** : √âvite les conflits avec NPCRoadRage
- üÜï R√©servation intelligente des PNJ
- üÜï D√©tection automatique des PNJ occup√©s
- üÜï Protection des PNJ de police et d'urgence

#### **Contr√¥les de Debug Ajout√©s**
- üéÆ **F11** : Affichage des informations de debug d√©taill√©es
- üéÆ **F10** : Activation forc√©e du syst√®me (test)
- üéÆ **F9** : R√©initialisation compl√®te du syst√®me

#### **Corrections Techniques**
- üîß Correction des erreurs de compilation SHVDN
- üîß Mise √† jour des API obsol√®tes
- üîß Correction des signatures de m√©thodes
- üîß Ajout des classes manquantes (RoutineSteps, SpecialEventType)

### üìÅ **Nouveaux Fichiers**
- `UrbanLife/UrbanLifeConfig.cs` - Configuration centralis√©e
- `UrbanLife/UrbanLifeIntegration.cs` - Syst√®me d'int√©gration
- `UrbanLife/README_CORRECTIONS.md` - Documentation des corrections
- `UrbanLife/GUIDE_UTILISATION.md` - Guide d'utilisation

### üéØ **R√©sultat Final**
Le syst√®me UrbanLife est maintenant **stable, performant et non-intrusif**. Les PNJ se comportent naturellement sans r√©actions excessives, tout en conservant les fonctionnalit√©s d'am√©lioration de l'IA pour les √©v√©nements importants.

---

## [Version 1.3.x] - Versions Pr√©c√©dentes

### üöó **NPCRoadRage System**
- Syst√®me de r√©action des PNJ aux collisions
- Gestion des interactions avec la police
- Menu de r√©ponses interactif

### üèõÔ∏è **Criminal Record System**  
- Syst√®me d'enregistrement des crimes
- Int√©gration avec les forces de l'ordre
- Persistance des donn√©es criminelles

### ‚õΩ **Fuel System**
- Syst√®me de carburant r√©aliste
- Gestion de la consommation
- Stations-service fonctionnelles

### üöô **Vehicle Handling**
- Am√©lioration du comportement des v√©hicules
- Syst√®me d'usure des pneus
- Int√©grit√© r√©aliste des v√©hicules

---

**Note** : Cette version 1.4.0 r√©sout les probl√®mes majeurs signal√©s avec le syst√®me UrbanLife. Le mod est maintenant stable et pr√™t pour une utilisation normale. 